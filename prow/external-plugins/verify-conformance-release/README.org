* verify-conformance-release

The behaviour of the bot is described here, in [[https://cucumber.io/docs/gherkin/][Gherkin]].  Each scenario is a requirement a PR must meet to qualify for conformance.

Note: the line immediately beneath the scenario is the comment posted to the PR if the requirement is not met.
#+begin_src feature :tangle ./kodata/features/verify-conformance-release.feature
Feature: verify conformance product submission PR

  Scenario: PR title is not empty
    it seems that there is no title set

    Given a PR title
    Then the PR title is not empty

  Scenario: submission contains all required files
    there seems to be some required files missing (https://github.com/cncf/k8s-conformance/blob/master/instructions.md#contents-of-the-pr)

    Given <file> is included in its file list
    Then <file> is not empty
    And <file> is valid <type>

    Examples:
      | file           | type       |
      | "README.md"    | "markdown" |
      | "PRODUCT.yaml" | "yaml"     |
      | "e2e.log"      | "text"     |
      | "junit_01.xml" | "xml"      |

  Scenario: submission has files in structure of releaseversion/productname/
    the submission file directory does not seem to match the Kubernetes release version in the files

    Given the files in the PR
    Then file folder structure matches "(v1.[0-9]{2})/(.*)"
    # $1 is the release version of Kubernetes
    # $2 is the product name
    # example: v1.23/coolthing

  Scenario: submission is only one product
    the submission seems to contain files of multiple Kubernetes release versions or products. Each Kubernetes release version and products should be submitted in a separate PRs

    Given the files in the PR
    Then there is only one path of folders

  Scenario: submission release version in title matches release version in folder structure
    the title of the submission does not seem to contain a Kubernetes release version that matches the release version in the submitted files

    Given the files in the PR
    And the title of the PR
    Then the release version matches the release version in the title

  Scenario: the PRODUCT.yaml metadata contains all required fields
    it appears that the PRODUCT.yaml file does not contain all the required fields (https://github.com/cncf/k8s-conformance/blob/master/instructions.md#productyaml)

    Given a "PRODUCT.yaml" file
    Then the yaml file "PRODUCT.yaml" contains the required and non-empty <field>

    Examples:
      | field               |
      | "vendor"            |
      | "name"              |
      | "version"           |
      | "type"              |
      | "description"       |
      | "website_url"       |
      | "documentation_url" |

  Scenario: the URL fields in the PRODUCT.yaml are valid URLs
    it appears that URL(s) in the PRODUCT.yaml aren't correctly formatted URLs

    Given a "PRODUCT.yaml" file
    Then the content of the url in the value of <field> is a valid URL

    Examples:
      | field               |
      | "website_url"       |
      | "repo_url"          |
      | "documentation_url" |
      | "product_logo_url"  |

  Scenario: the URL fields in the PRODUCT.yaml resolve to their specified data types
    it appears that URL(s) in the PRODUCT.yaml don't resolve to the correct data type

    Given a "PRODUCT.yaml" file
    Then the content of the url in the value of <field> matches it's <dataType>

    Examples:
      | field               | dataType                           |
      | "website_url"       | "text/html"                        |
      | "repo_url"          | "text/html"                        |
      | "documentation_url" | "text/html"                        |
      | "product_logo_url"  | "image/svg application/postscript" |

  Scenario: title of product submission contains Kubernetes release version and product name
    the submission title is missing either a Kubernetes release version (v1.xx) or product name

    Given the title of the PR
    Then the title of the PR matches "(.*) (v1.[0-9]{2})[ /](.*)"
    # $1 is the string for conformance results for
    # $2 is the version of Kubernetes
    # $3 is the product name
    # example: Conformance test for v1.23 Cool Engine

  Scenario: the e2e.log output contains the Kubernetes release version
    it seems the e2e.log does not contain the Kubernetes release version that match the submission title

    Given an "e2e.log" file
    Then a line of the file "e2e.log" matches "^.*e2e test version: (v1.[0-9]{2}(.[0-9]{1,2})?)$"
    And that version matches the same Kubernetes release version as in the folder structure
    # $1 is the release version of Kubernetes
    # $2 is the (optional) point release version of Kubernetes
    # example: Feb 25 10:20:32.383: INFO: e2e test version: v1.23.0

  Scenario: the submission release version is a supported version of Kubernetes
    the Kubernetes release version in this pull request does not qualify for conformance submission anymore (https://github.com/cncf/k8s-conformance/blob/master/terms-conditions/Certified_Kubernetes_Terms.md#qualifying-offerings-and-self-testing)

    Given the release version
    And the files in the PR
    Then it is a valid and supported release

  Scenario: all required conformance tests in the junit_01.xml are present
    it appears that some tests are missing from the product submission

    Given a "junit_01.xml" file
    Then all required tests in junit_01.xml are present

  Scenario: all tests pass in e2e.log
    it appears that some tests failed in the product submission

    Given an "e2e.log" file
    Then the tests pass and are successful
    And all required tests in e2e.log are present

  Scenario: the tests in junit_01.xml and e2e.log match
    it appears that there is a mismatch of tests in junit_01.xml and e2e.log

    Given an "e2e.log" file
    And a "junit_01.xml" file
    Then the tests match
#+end_src

* Prepare conformance metadata
#+begin_src shell
K8S_LATEST_VERSION=$(curl -L -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)
K8S_LATEST_MINOR_VERSION=$(awk '{split($1,array, "."); print array[2]}' <<< $K8S_LATEST_VERSION)
SETS=($(seq 15 $K8S_LATEST_MINOR_VERSION) master)
rm -r ./kodata/conformance-testdata/
mkdir -p ./kodata/conformance-testdata/{v1.{15..24},master}/

MANIFESTS=(
  https://raw.githubusercontent.com/cncf-infra/prow-config/master/docs/conformance_v1.{15..17}.yaml
  https://raw.githubusercontent.com/cncf-infra/prow-config/master/tests/conformance-1.18.yaml
  https://raw.githubusercontent.com/kubernetes/kubernetes/release-1.{19..24}/test/conformance/testdata/conformance.yaml
  https://raw.githubusercontent.com/kubernetes/kubernetes/master/test/conformance/testdata/conformance.yaml
)

re="^.*([0-9].[0-9]{2}|master).*$"
for METADATA in ${MANIFESTS[*]}; do
    if [[ $METADATA =~ $re ]]; then
        version=${BASH_REMATCH[1]}

        semver="v${version}"
        if [ "${version}" = master ]; then
            semver="${version}"
        fi
        curl -L \
            -o ./kodata/conformance-testdata/${semver}/conformance.yaml \
            ${METADATA}
    fi
done
#+end_src

#+RESULTS:
#+begin_example
#+end_example

* Build locally
#+begin_src tmate :window prow-config
ko build --local -B --tags latest .
#+end_src

* Set up local dev
Log into GitHub regularly
#+begin_src tmate :window prow-config
unset GITHUB_TOKEN
gh auth login
#+end_src

Update the oauth secret
#+begin_src shell
kubectl -n prow create secret generic prow-github-oauth \
    --from-literal=oauth=$(yq e '."github.com".oauth_token' -P - < ~/.config/gh/hosts.yml) \
    --dry-run=client -o yaml \
    | kubectl apply -f -
#+end_src

#+RESULTS:
#+begin_example
secret/prow-github-oauth configured
#+end_example

Install the config
#+begin_src shell
kubectl -n prow create cm vcr-config --from-file=vcr.yaml=./vcr.yaml --dry-run=client -o yaml | \
    kubectl -n prow apply -f -
#+end_src

#+RESULTS:
#+begin_example
configmap/vcr-config created
#+end_example

Install the plugin
#+begin_src shell
kubectl -n prow apply -f verify-conformance-release-deployment-dev-temp.yaml
#+end_src

#+RESULTS:
#+begin_example
deployment.apps/verify-conformance-release created
#+end_example

Read the logs
#+begin_src tmate :window prow-config
kubectl -n prow logs -l app=verify-conformance-release --tail=50 -f
#+end_src

Restart it
#+begin_src tmate :window prow-config
kubectl -n prow rollout restart deployment verify-conformance-release
#+end_src

#+RESULTS:
#+begin_example
deployment.apps/verify-conformance-release restarted
#+end_example

Uninstall the plugin
#+begin_src shell
kubectl -n prow delete -f verify-conformance-release-deployment-dev-temp.yaml
#+end_src

#+RESULTS:
#+begin_example
deployment.apps "verify-conformance-release" deleted
#+end_example

* Run trial-implementation
#+begin_src tmate :window trial-implementation
cd ./trial-implementation
go run .
#+end_src

* Running the plugin locally

The plugin can be run locally as follows, when run locally the plugin interacts with GitHub but by default does not make any changes
if you want to apply changes to the PR inspected then you can pass in the flag, dry-run=false

#+BEGIN_SRC shell
./verify-conformance-release --hmac-secret-file=/home/ii/.secret-hook --github-token-path=/home/ii/.secret-oauth --plugin-config=./vcr.yaml
#+END_SRC
